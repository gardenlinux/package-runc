#!/usr/bin/make -f

include /usr/share/dpkg/pkg-info.mk

export DH_GOLANG_EXCLUDES      := libcontainer/integration contrib/cmd

TAGS    := seccomp urfave_cli_no_docs
LDFLAGS := -X main.version=$(DEB_VERSION_UPSTREAM) -X main.gitCommit=$(DEB_VERSION)

%:
	dh $@ --buildsystem=golang --with=golang --builddirectory=_build

execute_after_dh_auto_build:
	cd man && ./md2man-all.sh

override_dh_auto_configure:
	# needed by src/github.com/opencontainers/runc/vendor/google.golang.org/protobuf/internal/editiondefaults/defaults.go
	mkdir -p _build/src/github.com/opencontainers/runc/vendor/google.golang.org/protobuf/internal/editiondefaults
	cp vendor/google.golang.org/protobuf/internal/editiondefaults/editions_defaults.binpb _build/src/github.com/opencontainers/runc/vendor/google.golang.org/protobuf/internal/editiondefaults/
	# needed by src/github.com/opencontainers/runc/main.go
	mkdir -p _build/src/github.com/opencontainers/runc
	cp VERSION _build/src/github.com/opencontainers/runc/
	dh_auto_configure -O--buildsystem=golang -O--builddirectory=_build

override_dh_auto_build:
	dh_auto_build -- -tags "$(TAGS)" -ldflags "$(LDFLAGS)"

override_dh_auto_test:
	dh_auto_test -- -tags "$(TAGS)"
